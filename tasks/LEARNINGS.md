# Bknd Deployment Learnings

- Bknd supports multiple deployment platforms: Vercel, AWS Lambda, Cloudflare Workers, Docker, and standalone Node.js servers
- PostgreSQL adapters (`pg` and `postgresJs`) are available directly from the `bknd` package as of v0.20.0 (previously in separate `@bknd/postgres` package)
- `pg` adapter uses node-postgres Pool for connection pooling, best for traditional Node.js deployments
- `postgresJs` adapter uses postgres package, best for edge runtimes (Vercel Edge Functions, Cloudflare Workers)
- Turso provides edge-hosted SQLite database, requires two environment variables: `TURSO_URL` and `TURSO_AUTH_TOKEN`
- For AWS Lambda deployment, need to bundle with esbuild and copy Admin UI assets with `npx bknd copy-assets --out=static`
- Lambda handler uses `serve()` from `bknd/adapter/aws` and exports a default export
- Cloudflare Workers uses D1 database bindings configured in `wrangler.json` and `serve()` from `bknd/adapter/cloudflare`
- Docker deployment uses CLI mode with `ARGS` environment variable to pass database URL
- Production media storage requires cloud providers (AWS S3, Cloudflare R2) - local filesystem doesn't work in serverless environments
- Code Mode recommended for production to ensure schema is versioned in code; Database Mode works for development
- Edge runtime can be enabled in Vercel by adding `export const runtime = "edge"` to API route
- Docker Compose examples show how to run Bknd with PostgreSQL in containers with volume persistence
- Skill files use YAML frontmatter with `name` and `description` fields; description should include trigger phrases like "Use when..."
- Skills should include DOs and DON'Ts sections for best practices
- Skills should end with "Related Skills" section linking to other relevant skills
- When testing skill triggers, verify YAML frontmatter validity with `head -3` check on each SKILL.md file
- Skill line counts can be checked with `wc -l` - target 200-400 lines per PRD, but variance acceptable if content is focused
- Semantic matching in Claude Code relies heavily on description field containing "Use when..." trigger phrases
- When reviewing keyword coverage, add framework-specific keywords (e.g., "Remix, Nuxt") to integration skills and cloud provider keywords (e.g., "Supabase, PlanetScale") to infrastructure skills to improve semantic matching for users mentioning related technologies
- **CRITICAL Bknd API distinction:** The `em()` function returns a schema definition object (with `toJSON()`, `entities`, `proto`, etc.), NOT a queryable EntityManager. For runtime queries in Code Mode, use `api.data.readMany()`, `api.data.createOne()`, etc. via TypeScript SDK. For Hybrid Mode with direct database access, use `app.em.repo()` or `app.em.mutator()` AFTER calling `app.build()`.
- **Primary key configuration:** The `primary()` function is NOT exported from "bknd" package in v0.20.0. Primary keys are automatically generated (integer or UUID). To customize format, use `entity("name", {...fields}, { primary_format: "uuid" })`.
- **Field type naming:** The enum field type function is `enumm()` (double 'm'), NOT `enum()` which would shadow JavaScript's reserved keyword.
- **Use opensrc for API verification:** When verifying Bknd APIs across version changes, use `npx opensrc bknd` to fetch the actual source code and check what's exported from the main `index.ts` file. This is faster than webfetch and provides complete repository context.
- **Repository access patterns:** For Hybrid Mode direct database access, use `app.em.repo('Entity')` or `app.em.repository('Entity')` AFTER calling `await app.build()`. The `app.em` property provides the EntityManager instance with `repo()` and `mutator()` methods. For Code Mode queries, use the TypeScript SDK via `api.data.readMany()`, `api.data.readOne()`, etc.
- **WhereBuilder operators verified:** `$eq`, `$ne`, `$gt`, `$gte`, `$lt`, `$lte`, `$isnull`, `$in`, `$notin`, `$between`, `$like`. All are correct in query skill.
- **RepoQuery options verified:** `limit` (default 10), `offset` (default 0), `sort` (string or object with `by`/`dir`), `where` (WhereQuery), `select` (string array), `join` (string array), `with` (nested RepoQuery for eager loading). All are correct in query skill.
 - **Project setup commands:** Use `npx bknd create my-app --integration vite --template react` instead of manual `npm create` commands. The CLI supports `--integration` (vite, bun, nextjs, astro, cloudflare, aws, deno) and `--template` options for scaffolding.
 - **Plugin import verification:** Plugins like `emailOTP` are exported from `'bknd/plugins'` subpackage (via `node_modules/bknd/dist/plugins/index.js`), while core utilities like `resendEmail` are exported from main `'bknd'` package. Always check `package.json` exports field and `dist/` structure to verify correct import paths.
 - **Permission names in v0.20.0:** Data permissions use `data.entity.read`, `data.entity.create`, `data.entity.update`, `data.entity.delete` (not `entityRead`, `entityCreate`, etc.). Schema permissions use `system.schema.read`, `system.access.api`, etc. All data permissions are filterable (including `create`).
 - **Policy variable syntax:** Use `@auth.user.*` (not `@user.*`) for accessing authenticated user properties in policy filters. For example, `@auth.user.id`, `@auth.user.role`, `@auth.user.email`. The `@ctx.*` prefix is for custom Guard context variables.

